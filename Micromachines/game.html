<body>
up/left/right = move, c = enable/disable clip, a = enable/disable ai
<div id="canvas" style="position: relative;">
 <canvas id="map" style="position: absolute; left: 0; top: 0; z-index: 0;"></canvas>
 <canvas id="player" style="position: absolute; left: 0; top: 0; z-index: 1;"></canvas>
</div>
</body>

<script src="workshop3.js"></script>
<script src="bathroom1.js"></script>
<script src="kitchen1.js"></script>
<script src="dining3.js"></script>

<script>

var ai = true;
var clip = true;

var gamemap = {};
var sprites = {};
var vehicle = {};

loadSprites();

function loadSprites()
{
  var img = new Image();
  img.src = game.tiles;
  img.onload = function()
  {
    sprites.origin = this;
    sprites.tilesX = this.width / 32;
    sprites.tilesY = this.height / 32;

    loadVehicle();
  }
}

function loadVehicle()
{
  var img = new Image();
  img.src = game.vehicle;
  img.onload = function()
  {
    vehicle.origin = this;
    vehicle.tilesX = this.width / 24;
    vehicle.tilesY = this.height / 24;

    buildMap();
  }
}

function buildMap()
{
  if (game.bin)
  {
    game.width = game.bin.charCodeAt(1);
    game.height = game.bin.charCodeAt(3);

console.log([game.width.toString(16), game.height.toString(16)]);
//    game.map = game.bin.substr(4, game.width*game.height);
//    game.tra = game.bin.substr(4+game.width*game.height, game.width*game.height);
    game.map = [];
    game.tra = [];
    game.col = [];
    for (var y=0; y<game.height; y++)
      for (var x=0; x<game.width; x++)
      {
        game.map[y*game.width+x] = game.bin.charCodeAt(4+x*game.height+y);
        game.tra[y*game.width+x] = game.bin.charCodeAt(4+game.width*game.height+x*game.height+y);
        game.col[y*game.width+x] = game.wrd.charCodeAt(4+game.width*game.height*2+(x*game.height+y)*2);
      }

//console.log([game.width, game.height, game.width*game.height*2+4]);
  }

  gamemap.element = document.getElementById("map");

  gamemap.can = gamemap.element; //document.createElement("canvas");
  gamemap.ctx = gamemap.can.getContext('2d');
  gamemap.can.width = game.width * 32;
  gamemap.can.height = game.height * 32;
  gamemap.ctx.width = game.width * 32;
  gamemap.ctx.height = game.height * 32;

  gamemap.ctx.fillStyle = "rgba(255, 255, 255, 0.5)";

  for (var y=0; y<game.height; y++)
    for (var x=0; x<game.width; x++)
    {
      var spriteI = game.map[y*game.width+x];
      var spriteX = spriteI % sprites.tilesX;
      var spriteY = Math.floor(spriteI / sprites.tilesX);
      gamemap.ctx.drawImage(sprites.origin, spriteX*32, spriteY*32, 32, 32, x*32, y*32, 32, 32);
      if (game.wrd)
        gamemap.ctx.fillText(game.col[y*game.width+x], x*32+8, y*32+20);
    }
 
  vehicle.element = document.getElementById("player");
  vehicle.can = vehicle.element; //document.createElement("canvas");
  vehicle.ctx = vehicle.can.getContext('2d');
  vehicle.can.width = 24;
  vehicle.can.height = 24;
  vehicle.ctx.width = 24;
  vehicle.ctx.height = 24;

  vehicle.angle = 0;
  vehicle.x = 450;
  vehicle.y = 450;

  vehicle.accel = false;
  vehicle.brake = false;
  vehicle.spd = 0;
  vehicle.vx = 0;
  vehicle.vy = 0;

  initView();

  setInterval(function()
  {
    if (key.state[key.kLeft] || key.state[key.kRight] || key.state[key.kUp])
      ai = false;
   
    if (key.state[key.kLeft])    
      vehicle.angle -= 5;

    if (key.state[key.kRight])
      vehicle.angle += 5;

    vehicle.accel = key.state[key.kUp];

    if (ai)
      aiVehicle();

    moveVehicle();
    drawVehicle();

    updateView();
  }, 50);
}

var viewCanvas = {};

function initView()
{
  if (clip)
  {
    viewCanvas.width = 400;
    viewCanvas.height = 400;

    viewCanvas.element = document.getElementById("canvas");
    viewCanvas.element.style.overflow = "hidden"; 
    viewCanvas.element.style.width = viewCanvas.width + "px";
    viewCanvas.element.style.height = viewCanvas.height + "px";
  } else
  {
    viewCanvas.element = document.getElementById("canvas");
    viewCanvas.element.style.overflow = "visible"; 
    gamemap.element.style.left = 0;
    gamemap.element.style.top = 0;
  }
}

function updateView()
{
  if (!clip || !viewCanvas.element)
    return;

  var targetVehicleX = viewCanvas.width/2 - 12;
  var targetVehicleY = viewCanvas.width/2 - 12;

  var moveX = targetVehicleX - vehicle.x;
  var moveY = targetVehicleY - vehicle.y;

  vehicle.element.style.left = targetVehicleX;
  vehicle.element.style.top = targetVehicleY;

  gamemap.element.style.left = moveX;
  gamemap.element.style.top = moveY;
}

function angleDiff(a, b)
{
  var d = b-a;
  if (d > 180)
    d -= 360;
  if (d < -180)
    d += 360;
  return d;
}

function aiVehicle()
{
  var blkx = Math.floor(vehicle.x / 32);
  var blky = Math.floor(vehicle.y / 32);

  if (blkx < 0 || blky < 0 || blkx >= game.width || blky >= game.height)
    return;

  var target = game.tra[blky * game.width + blkx];
  var targetAngle = ((target-1) / 0x20)*360;

  var diff = angleDiff(vehicle.angle, targetAngle);

  if (diff >= 5)
    vehicle.angle += 5;

  if (diff <= -5)
    vehicle.angle -= 5;

  vehicle.accel = Math.abs(diff) < 30;
  vehicle.brake = Math.abs(diff) > 50;
}

function moveVehicle()
{
  if (vehicle.accel)
  {
    var k = 0.5;
    vehicle.vy -= Math.cos(vehicle.angle/180*Math.PI) * k;
    vehicle.vx += Math.sin(vehicle.angle/180*Math.PI) * k;
  }

  vehicle.x += vehicle.vx;
  vehicle.y += vehicle.vy;

  if (vehicle.brake)
  {
    vehicle.vx *= 0.4;
    vehicle.vy *= 0.4;
  } else
  {
    vehicle.vx *= 0.9;
    vehicle.vy *= 0.9;
  }

  vehicle.element.style.left = vehicle.x - 12;
  vehicle.element.style.top = vehicle.y - 12;

  if (vehicle.angle >= 360) 
    vehicle.angle -= 360;

  if (vehicle.angle < 0) 
    vehicle.angle += 360;
}

function drawVehicle()
{
  var angleI = Math.floor(vehicle.angle * 32 / 360) % 32;
  var spriteI = angleI % 8;

  if (typeof(vehicle.lastAngleI) != "undefined" && vehicle.lastAngleI == angleI)
    return;

  vehicle.lastAngleI = angleI;

  vehicle.ctx.clearRect(0, 0, vehicle.ctx.width, vehicle.ctx.height);

  switch (Math.floor(angleI/8))
  {
    case 0:
      vehicle.ctx.drawImage(vehicle.origin, spriteI*24, 0*24, 24, 24, 0, 0, 24, 24);
      break;

    case 1:
      spriteI = 8 - spriteI;
      spriteX = spriteI % vehicle.tilesX;

      vehicle.ctx.save();
      vehicle.ctx.scale(1, -1);
      vehicle.ctx.drawImage(vehicle.origin, spriteI*24, 0*24, 24, 24, 0, 0, 24, -24);
      vehicle.ctx.restore();
      break;

    case 2:
      vehicle.ctx.save();
      vehicle.ctx.scale(-1, -1);
      vehicle.ctx.drawImage(vehicle.origin, spriteI*24, 0*24, 24, 24, 0, 0, -24, -24);
      vehicle.ctx.restore();
      break;

    case 3:
      spriteI = 8 - spriteI;

      vehicle.ctx.save();
      vehicle.ctx.scale(-1, 1);
      vehicle.ctx.drawImage(vehicle.origin, spriteI*24, 0*24, 24, 24, 0, 0, -24, 24);
      vehicle.ctx.restore();
      break;
  }

}

document.onkeyup   = function ( e ) { onKey( ( window.event ) ? event.keyCode : e.keyCode, 0 ); }
document.onkeydown = function ( e ) { onKey( ( window.event ) ? event.keyCode : e.keyCode, 1 ); }

var key = { state:[], kUp: 38, kRight: 39, kDown: 40, kLeft: 37};
function onKey( k, on )
{
  if (k > 0 && k < 100)
    key.state[k] = on;
  if (k == 65 & on) // 'a' 
    ai = !ai;
  if (k == 67 && on) // 'c'
  {
    clip = !clip;
    initView();
  }
}

</script>